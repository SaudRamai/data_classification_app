================================================================================
üìã DATABASE FIX SUMMARY FOR SOCIAL_SECURITY_NUMBER
================================================================================

YOUR DATA:
----------
KEYWORD_ID: dc825979-d136-4076-bb75-30288c8ef6e5
CATEGORY_ID: 3e47f6fd-d870-41a8-b75f-e967bb839475  ‚Üê This is the issue!
KEYWORD_STRING: SOCIAL_SECURITY_NUMBER
SENSITIVITY_WEIGHT: 0.8
IS_ACTIVE: TRUE
VERSION_NUMBER: 3

THE PROBLEM:
------------
That CATEGORY_ID (3e47f6fd-d870-41a8-b75f-e967bb839475) is probably pointing 
to SOC2 instead of PII.

When the classification pipeline loads keywords:
  1. It queries: JOIN SENSITIVE_KEYWORDS with SENSITIVITY_CATEGORIES
  2. It gets: KEYWORD_STRING='SOCIAL_SECURITY_NUMBER', CATEGORY_NAME='SOC2'
  3. It groups: SOC2_keywords = ['SOCIAL_SECURITY_NUMBER', ...]
  4. When matching columns, it finds SSN in SOC2 list
  5. Result: Classified as SOC2 ‚ùå

THE FIX:
--------

Option 1: Quick Fix (One Command)
----------------------------------
snowsql -f sql/fix_ssn_quick.sql

This runs a simple UPDATE to change CATEGORY_ID to PII's ID.

Option 2: Comprehensive Fix (With Diagnostics)
-----------------------------------------------
snowsql -f sql/fix_ssn_comprehensive.sql

This:
  ‚úÖ Shows what CATEGORY_ID currently represents
  ‚úÖ Gets correct PII CATEGORY_ID  
  ‚úÖ Updates the record
  ‚úÖ Checks for duplicates and removes them
  ‚úÖ Verifies the fix worked
  ‚úÖ Shows what the pipeline will load

AFTER RUNNING THE FIX:
----------------------

1. ‚úÖ Run the SQL script (either option above)

2. üîÑ Restart Streamlit app
   - IMPORTANT: Must restart to reload keywords from database
   - Old session may have cached the wrong category

3. üöÄ Run AI Classification Pipeline
   - Click "Run Classification Pipeline"
   - Wait for it to complete

4. ‚úÖ Verify Result
   - Drill down into table with SOCIAL_SECURITY_NUMBER column
   - Should now show category = PII
   - Should NOT show category = SOC2

VERIFICATION QUERY:
-------------------

After running the fix, verify with:

SELECT 
    sk.KEYWORD_STRING,
    sc.CATEGORY_NAME AS SHOULD_BE_PII,
    sk.CATEGORY_ID
FROM DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVE_KEYWORDS sk
JOIN DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVITY_CATEGORIES sc
  ON sk.CATEGORY_ID = sc.CATEGORY_ID
WHERE sk.KEYWORD_ID = 'dc825979-d136-4076-bb75-30288c8ef6e5';

Expected result:
  KEYWORD_STRING: SOCIAL_SECURITY_NUMBER
  SHOULD_BE_PII: PII  ‚Üê Must say 'PII'!
  CATEGORY_ID: <some UUID different from 3e47f6fd-d870-41a8-b75f-e967bb839475>

WHY YOUR INLINE EDIT DIDN'T WORK:
----------------------------------

When you used the UI to edit and select "PII":
  1. The upsert_sensitive_keyword() method was called
  2. It called get_category_id_by_name('PII') to get PII's CATEGORY_ID
  3. Something went wrong - either:
     a) get_category_id_by_name() returned wrong ID
     b) The UPDATE didn't execute properly
     c) Database transaction didn't commit
     d) Wrong database/schema was updated

The result: CATEGORY_ID stayed as 3e47f6fd-d870-41a8-b75f-e967bb839475 (SOC2)

RECOMMENDED APPROACH:
---------------------

1. Run: snowsql -f sql/fix_ssn_comprehensive.sql
   
   This will:
   - Diagnose exactly what's wrong
   - Fix the CATEGORY_ID
   - Clean up any duplicates
   - Verify everything
   
2. Read the output carefully:
   - First query shows current category (probably SOC2)
   - Second query shows correct PII category ID
   - UPDATE changes CATEGORY_ID
   - Verification shows new category (must be PII)

3. Restart Streamlit app:
   - Close the app
   - Restart it fresh
   - This clears any cached keyword data

4. Test classification:
   - Run pipeline
   - Check results
   - Shouldsee PII

IF STILL NOT WORKING AFTER FIX:
--------------------------------

If you run the fix and it still detects as SOC2:

Possibility 1: Wrong Database/Schema
  - Fix went to DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE
  - But pipeline loads from DATA_CLASSIFICATION_GOVERNANCE.DATA_CLASSIFICATION_GOVERNANCE
  - Check which schema the pipeline is actually using

Possibility 2: Duplicates
  - Multiple SOCIAL_SECURITY_NUMBER entries exist
  - One is PII (fixed)
  - One is SOC2 (still there)
  - Pipeline loads SOC2 one
  - Solution: Delete all except PII one

Possibility 3: Caching
  - App cached the old keyword data
  - Restart didn't clear it
  - Solution: Clear browser cache, restart app completely

Possibility 4: Code Override
  - Hardcoded logic forces SSN to SOC2
  - Check for any IF statements that set category based on keyword
  - Search for "SOCIAL_SECURITY_NUMBER" in code

QUICK TEST:
-----------

To verify the database fix worked without restarting app:

SELECT 
    sc.CATEGORY_NAME,
    COUNT(*) as KEYWORD_COUNT
FROM DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVE_KEYWORDS sk
JOIN DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVITY_CATEGORIES sc
  ON sk.CATEGORY_ID = sc.CATEGORY_ID
WHERE sk.IS_ACTIVE = TRUE
GROUP BY sc.CATEGORY_NAME
ORDER BY sc.CATEGORY_NAME;

Expected after fix:
  PII: 13 keywords (includes SOCIAL_SECURITY_NUMBER)
  SOX: 9 keywords
  SOC2: 7 keywords (does NOT include SOCIAL_SECURITY_NUMBER)

FILES TO USE:
-------------
üìÑ sql/fix_ssn_quick.sql - Simple one-command fix
üìÑ sql/fix_ssn_comprehensive.sql - Complete fix with diagnostics
üìÑ sql/check_category_id.sql - Check what CATEGORY_ID represents

BOTTOM LINE:
------------
Run: snowsql -f sql/fix_ssn_comprehensive.sql
Then: Restart app
Then: Test classification
Should work! ‚úÖ

================================================================================
