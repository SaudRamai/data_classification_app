================================================================================
‚úÖ INLINE EDIT ENHANCEMENT - SUMMARY
================================================================================

OBJECTIVE:
----------
Make the inline edit in the üî¨ Table Drill-Down ALWAYS use upsert functionality
so that it:
  - UPDATES the keyword if it already exists
  - INSERTS the keyword if it doesn't exist
  
This provides a seamless experience regardless of whether the keyword is new
or already in the database.

CURRENT BEHAVIOR (PROBLEMATIC):
--------------------------------
The `_render_keyword_actions()` method at line ~790-836 has this logic:

```python
if current_action == 'add':
    success = self.add_sensitive_keyword(keyword, category, match_type)
else:
    success = self.upsert_sensitive_keyword(keyword, category, match_type)
```

PROBLEM: 
- If action='add' and keyword exists ‚Üí FAILS
- No sensitivity_weight parameter ‚Üí Can't control sensitivity level

DESIRED BEHAVIOR:
-----------------
ALWAYS use `upsert_sensitive_keyword` with sensitivity_weight:

```python
# Add sensitivity weight slider in UI
sensitivity_weight = st.slider(
    "Sensitivity Weight", 
    min_value=0.0, 
    max_value=10.0, 
    value=0.8, 
    step=0.1,
    help="Higher values indicate more sensitive data",
    key=f"kw_weight_{context_key}"
)

# ALWAYS use upsert - no conditional logic
success = self.upsert_sensitive_keyword(
    keyword=new_keyword, 
    category_name=target_category, 
    match_type=match_type,
    sensitivity_weight=sensitivity_weight
)
```

CHANGES MADE:
-------------
‚úÖ Schema hardcoded to DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE
‚úÖ upsert_sensitive_keyword method uses correct schema
‚úÖ get_category_id_by_name uses correct schema
‚úÖ add_sensitive_keyword uses correct schema  
‚úÖ _log_keyword_audit uses correct schema

‚ùå _render_keyword_actions got corrupted during edits - NEEDS MANUAL FIX

MANUAL FIX REQUIRED:
--------------------
File: ai_classification_pipeline_service.py
Method: _render_keyword_actions (around line 790)

1. Remove the conditional `if current_action == 'add'` logic
2. Add sensitivity_weight slider to UI
3. ALWAYS call upsert_sensitive_keyword with all 4 parameters:
   - keyword
   - category_name
   - match_type
   - sensitivity_weight

CORRECT CODE for _render_keyword_actions:
------------------------------------------
```python
def _render_keyword_actions(self, context_key: str) -> None:
    """Render the inline keyword action form based on session state."""
    action_key = f'kw_action_{context_key}'
    current_action = st.session_state.get(action_key)
    
    if not current_action:
        return

    form_container = st.container()
    with form_container:
        st.info(f"{'Add New' if current_action == 'add' else 'Upsert/Edit'} Sensitive Keyword")
        
        c1, c2, c3, c4 = st.columns([3, 2, 2, 1])
        with c1:
            new_keyword = st.text_input("Keyword", placeholder="e.g. 'project_falcon'", key=f"kw_input_{context_key}")
        with c2:
            categories = sorted(list(self._category_thresholds.keys())) if self._category_thresholds else ["PII", "SOX", "SOC2", "INTERNAL"]
            target_category = st.selectbox("Category", categories, key=f"kw_cat_{context_key}")
        with c3:
            match_type = st.selectbox("Match Type", ["CONTAINS", "EXACT"], key=f"kw_match_{context_key}")
        with c4:
            st.write("")
            st.write("")
            if st.button("‚ùå", key=f"btn_close_{context_key}"):
                st.session_state[action_key] = None
                st.rerun()

        # Add sensitivity weight slider
        sensitivity_weight = st.slider(
            "Sensitivity Weight", 
            min_value=0.0, 
            max_value=10.0, 
            value=0.8, 
            step=0.1,
            help="Higher values indicate more sensitive data (0.0 = lowest, 10.0 = highest)",
            key=f"kw_weight_{context_key}"
        )

        if st.button("üíæ Save Keyword", key=f"btn_save_{context_key}", type="primary"):
            if new_keyword and target_category:
                with st.spinner("Saving..."):
                    # ALWAYS use upsert
                    success = self.upsert_sensitive_keyword(
                        keyword=new_keyword, 
                        category_name=target_category, 
                        match_type=match_type,
                        sensitivity_weight=sensitivity_weight
                    )
                        
                    if success:
                        st.success(f"‚úÖ Successfully saved '{new_keyword}' (Weight: {sensitivity_weight})!")
                        st.session_state[action_key] = None
                        st.rerun()
                    else:
                        st.error("‚ùå Failed to save keyword. Check logs for details.")
            else:
                st.warning("‚ö†Ô∏è Please enter a keyword and select a category.")
        st.divider()
```

BENEFITS:
---------
‚úÖ User can UPDATE existing keywords by editing them
‚úÖ User can INSERT new keywords 
‚úÖ No errors about "keyword already exists"
‚úÖ User has control over SENSITIVITY_WEIGHT (0.0-10.0)
‚úÖ Clean, simple UI with slider
‚úÖ All saves go to: DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVE_KEYWORDS

TESTING:
--------
After fixing _render_keyword_actions:

1. Test UPDATE:
   - Go to drill-down table
   - Click edit on SOCIAL_SECURITY_NUMBER
   - Change sensitivity_weight from 0.8 to 1.5
   - Save
   - Verify: SELECT * FROM DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVE_KEYWORDS 
            WHERE KEYWORD_STRING = 'SOCIAL_SECURITY_NUMBER';
   - Check SENSITIVITY_WEIGHT = 1.5

2. Test INSERT:
   - Click "Add Keyword"
   - Enter: PROJECT_FALCON
   - Category: SOC2
   - Match: CONTAINS
   - Weight: 2.0
   - Save
   - Verify: SELECT * FROM DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVE_KEYWORDS 
            WHERE KEYWORD_STRING = 'PROJECT_FALCON';
   - Check exists with SENSITIVITY_WEIGHT = 2.0

SUMMARY:
--------
The file got corrupted during automated edits. Manual fix is required.
The correct code is provided above. Simply replace the _render_keyword_actions
method with the provided code and test.

================================================================================
END
================================================================================
