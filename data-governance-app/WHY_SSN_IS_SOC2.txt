================================================================================
üî¥ ROOT CAUSE: Why SOCIAL_SECURITY_NUMBER is Detected as SOC2
================================================================================

SUMMARY:
--------
The code is working correctly. The problem is in the DATABASE.

Your SENSITIVE_KEYWORDS table has the WRONG CATEGORY_ID for SOCIAL_SECURITY_NUMBER.

ROOT CAUSE ANALYSIS:
--------------------

1. DATABASE RECORD (Your Data):
   KEYWORD_ID: dc825979-d136-4076-bb75-30288c8ef6e5
   CATEGORY_ID: 3e47f6fd-d870-41a8-b75f-e967bb839475
   KEYWORD_STRING: social_security_number
   
   ‚ùå This CATEGORY_ID points to SOC2, NOT PII!

2. HOW CLASSIFICATION WORKS:
   
   Step 1: Load keywords from database
   ------------------------------------
   The classification pipeline calls _init_local_embeddings() or similar
   to load ALL keywords from SENSITIVE_KEYWORDS table.
   
   It runs a query like:
   SELECT 
       sk.KEYWORD_STRING,
       sc.CATEGORY_NAME,
       sk.SENSITIVITY_WEIGHT
   FROM SENSITIVE_KEYWORDS sk
   JOIN SENSITIVITY_CATEGORIES sc ON sk.CATEGORY_ID = sc.CATEGORY_ID
   WHERE sk.IS_ACTIVE = TRUE
   
   Result for your record:
   {
       'KEYWORD_STRING': 'social_security_number',
       'CATEGORY_NAME': 'SOC2',  ‚Üê WRONG! Should be 'PII'
       'SENSITIVITY_WEIGHT': 0.8
   }
   
   Step 2: Group keywords by category
   -----------------------------------
   The code creates dictionaries like:
   _category_keywords = {
       'PII': [...other PII keywords...],
       'SOC2': ['social_security_number', ...],  ‚Üê Goes into WRONG category!
       'SOX': [...]
   }
   
   Step 3: Match columns
   ---------------------
   When classifying a column named 'SOCIAL_SECURITY_NUMBER':
   - Converts to lowercase: 'social_security_number'
   - Checks PII keywords: NOT FOUND (because it's not in PII list!)
   - Checks SOC2 keywords: FOUND! 'social_security_number' is here
   - Result: Classified as SOC2 ‚ùå

3. WHY THE CODE ISN'T THE ISSUE:
   
   The code has these hardcoded keyword lists (for fallback/boosting):
   
   pii_boost_keywords = {
       'ssn', 'social_security', 'social_security_number', ...
   }
   
   But these are ONLY used as:
   a) Fallback if database is empty
   b) Boosting existing scores
   c) Tiebreakers
   
   The PRIMARY source is the DATABASE, which has the wrong category!

THE FIX:
--------

Update the CATEGORY_ID in the database to point to PII:

UPDATE SENSITIVE_KEYWORDS
SET 
    CATEGORY_ID = (SELECT CATEGORY_ID FROM SENSITIVITY_CATEGORIES WHERE CATEGORY_NAME = 'PII')
WHERE KEYWORD_ID = 'dc825979-d136-4076-bb75-30288c8ef6e5';

WHY YOUR INLINE EDITS 'DIDNT WORK:
-----------------------------------

When you edited the keyword in the UI and selected "PII", one of these happened:

Scenario A: The category didn't save
  - UI showed "success" but database UPDATE failed
  - Check application logs

Scenario B: Wrong CATEGORY_ID was fetched
  - get_category_id_by_name('PII') returned wrong ID
  - Need to verify SENSITIVITY_CATEGORIES table

Scenario C: Saving to wrong database/schema
  - Upsert went to DATA_CLASSIFICATION_GOVERNANCE.DATA_CLASSIFICATION_GOVERNANCE
  - But pipeline loads from DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE
  - Or vice versa

VERIFICATION STEPS:
-------------------

Step 1: Check what CATEGORY_ID actually means
----------------------------------------------
SELECT CATEGORY_ID, CATEGORY_NAME 
FROM DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVITY_CATEGORIES
WHERE CATEGORY_ID = '3e47f6fd-d870-41a8-b75f-e967bb839475';

If this returns 'SOC2', that's your problem!

Step 2: Get correct PII CATEGORY_ID
------------------------------------
SELECT CATEGORY_ID, CATEGORY_NAME 
FROM DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVITY_CATEGORIES
WHERE CATEGORY_NAME = 'PII';

You need this CATEGORY_ID.

Step 3: Update the keyword
--------------------------
UPDATE DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVE_KEYWORDS
SET CATEGORY_ID = '<PII_CATEGORY_ID_FROM_STEP2>'
WHERE KEYWORD_ID = 'dc825979-d136-4076-bb75-30288c8ef6e5';

Step 4: Verify
--------------
SELECT 
    sk.KEYWORD_STRING,
    sc.CATEGORY_NAME
FROM DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVE_KEYWORDS sk
JOIN DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE.SENSITIVITY_CATEGORIES sc
  ON sk.CATEGORY_ID = sc.CATEGORY_ID  
WHERE sk.KEYWORD_ID = 'dc825979-d136-4076-bb75-30288c8ef6e5';

Should return: CATEGORY_NAME = 'PII'

Step 5: Restart app and test
-----------------------------
1. Restart Streamlit app (IMPORTANT!)
2. Run classification pipeline
3. Should now detect as PII

CODE ANALYSIS:
--------------

I checked the classification code. Here's what happens:

File: ai_classification_pipeline_service.py

The classification flow:
1. _init_local_embeddings() or similar loads keywords from database
2. Keywords are grouped by CATEGORY_NAME (which comes from joining CATEGORY_ID)
3. During classification, columns are matched against keyword lists PER CATEGORY
4. If 'social_security_number' is in SOC2 list (from bad DB data), it matches SOC2
5. Result: Column categorized as SOC2

The hardcoded keyword lists (lines 6520-6553, 6724-6820) are:
- NOT the primary source
- Used for boosting/tiebreaking
- Can't override wrong database data

DEFINITIVE FIX:
---------------

Run this script:
  snowsql -f sql/fix_ssn_immediate.sql

This will:
‚úÖ Show current wrong category (SOC2)
‚úÖ Get correct PII category ID
‚úÖ Update CATEGORY_ID to PII
‚úÖ Normalize KEYWORD_STRING to uppercase
‚úÖ Verify the fix worked

After running:
‚úÖ Restart Streamlit app
‚úÖ Run classification pipeline
‚úÖ SOCIAL_SECURITY_NUMBER should now be PII

IF STILL NOT WORKING:
---------------------

1. Check if pipeline loads from different database:
   - Add logging to see which database/schema is being queried
   -  Check resolve_governance_db() output

2. Check for duplicate entries:
   SELECT * FROM SENSITIVE_KEYWORDS 
   WHERE LOWER(KEYWORD_STRING) = 'social_security_number';
   
   If multiple rows exist, delete all except the PII one.

3. Verify upsert_sensitive_keyword() is using correct schema:
   - Line ~1927: Should use DATA_CLASSIFICATION_DB.DATA_CLASSIFICATION_GOVERNANCE
   - Check logs when saving

4. Check SENSITIVITY_CATEGORIES table integrity:
   SELECT * FROM SENSITIVITY_CATEGORIES ORDER BY CATEGORY_NAME;
   
   Should have:
   - PII (with distinct CATEGORY_ID)
   - SOX (with distinct CATEGORY_ID)  
   - SOC2 (with distinct CATEGORY_ID)

BOTTOM LINE:
------------

The code keyword matching IS working correctly (case-insensitive).
The code database loading IS working correctly.
The problem is the DATABASE RECORD has wrong CATEGORY_ID.

Fix the database ‚Üí Problem solved.

Run: snowsql -f sql/fix_ssn_immediate.sql

================================================================================
